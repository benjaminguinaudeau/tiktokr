---
title: "statstiktok-usecase"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{rstats-usecase}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

First, let's load the `tiktokr` library and the `tidyverse`.

```{r setup}
library(tiktokr)
library(tidyverse)
```


Make sure to use your preferred Python installation

```{r}
library(reticulate)

use_python(py_config()$python)

```

The next two steps you only need to do once:

1. Install necessary Python libraries

```{r, eval = F}
tk_install()
```

2. Authentication

In November 2020, Tiktok increased its security protocol. They now frequently show a captcha, which is easily triggered after a few requests. This can be solved by specifying the cookie parameter. To get a cookie session: 

1. Open a browser and go to "http://tiktok.com"
2. Scroll down a bit, to ensure, that you don't get any captcha
3. Open the javascript console (in Chrome: View > Developer > Javascript Console)
4. Run `document.cookie` in the console. Copy the entire output (your cookie). 
5. Run `tk_auth()` in R and paste the cookie.

Click on image below for screen recording of how to get your TikTok cookie:

[<img src="https://github.com/benjaminguinaudeau/tiktokr/raw/master/data/preview.png" width="50%">](https://youtu.be/kYMV2ugxacs)

The `tk_auth` function will save cookies (and user agent) as environment variable to your `.Renviron` file. You need to only run this once to use the `tiktokr` or whenever you want to update your cookie/user agent.

```{r, eval = F}
tk_auth(cookie = "<paste here the output from document.cookie>")

```

## Getting #rstats TikTok 

Once per script you need to run `tk_init` to initialize `tiktokr`

```{r}
tk_init()

chelsea <- tk_posts(scope = "user", query = "chelseaparlettpelleriti", n = 2000)

chelsea %>% distinct(id)

```



```{r, eval = F}
stats_tiktok <- tk_posts(scope = "hashtag", query = "statstiktok", n = 2000)

stats_tiktok <- stats_tiktok %>% 
  distinct(id, .keep_all = T)
```
```{r, echo =FALSE}

load('../data/rstats_tiktok.rda')
```

Great! Now we have a dataset with metadata of tiktoks with rstats hashtag!

```{r}
glimpse(rstats_tiktok)
```

There are quite a few variables. We do not really care about many of them so as a first step we select only relevant variables. I also like to use `janitor` for cleaning up variable names.

```{r}
library(janitor)

rstats_tiktok <- rstats_tiktok %>% 
  select(id, createTime, 
         author_id:author_nickname, 
         author_signature, author_avatarLarger, 
         desc, music_id:authorStats_heart) %>% 
  clean_names() %>% 
  distinct(id, .keep_all = T)

glimpse(rstats_tiktok)
```

Let`s first check out the top posters in the data.

```{r}
rstats_tiktok %>% 
  # filter(author_unique_id == "baboutunt") %>% 
  # arrange(id)
  count(author_unique_id, sort = T)
```

